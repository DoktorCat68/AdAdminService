@model AdAdminPortal.Models.AdUserDto
@{
    ViewData["Title"] = "Пользователь " + Model.Sam;
    var userGroups = ViewBag.UserGroups as List<string> ?? new List<string>();
    var availableGroups = ViewBag.AvailableGroups as List<string> ?? new List<string>();
}

<h2>@Model.DisplayName (@Model.Sam)</h2>

<p><b>SAM:</b> @Model.Sam</p>
<p><b>E-mail:</b> @Model.Email</p>
<p><b>Статус:</b> @(Model.Enabled ? "Включён" : "Отключён")</p>
<p>
    <a asp-action="CreateLike" asp-route-id="@Model.Sam">
        Создать нового пользователя как @Model.DisplayName (@Model.Sam)
    </a>
</p>

@if (TempData["Error"] != null)
{
    <div style="color:red;">@TempData["Error"]</div>
}
@if (TempData["Message"] != null)
{
    <div style="color:green;">@TempData["Message"]</div>
}

<form asp-action="@(Model.Enabled ? "Disable" : "Enable")" method="post" style="margin-bottom: 1rem;">
    @Html.AntiForgeryToken()
    <input type="hidden" name="id" value="@Model.Sam" />
    <button type="submit">@(Model.Enabled ? "Отключить" : "Включить")</button>
</form>

<h3>Сброс пароля</h3>
<form asp-action="ResetPassword" method="post">
    @Html.AntiForgeryToken()
    <input type="hidden" name="id" value="@Model.Sam" />
    <div>
        <label>Новый пароль:</label><br />
        <input type="password" name="newPassword" />
    </div>
    <div>
        <label>Подтверждение:</label><br />
        <input type="password" name="confirmPassword" />
    </div>
    <div>
        <label><input type="checkbox" name="mustChange" checked /> Требовать смену при входе</label>
    </div>
    <button type="submit">Сбросить пароль</button>
</form>

<h3>Разблокировать учётку</h3>
<form asp-action="Unlock" method="post">
    @Html.AntiForgeryToken()
    <input type="hidden" name="id" value="@Model.Sam" />
    <button type="submit">Разблокировать</button>
</form>

<h3>Изменить данные</h3>
<form asp-action="UpdateUser" method="post">
    @Html.AntiForgeryToken()
    <input type="hidden" name="id" value="@Model.Sam" />
    <div>
        <label>Отображаемое имя:</label><br />
        <input type="text" name="displayName" value="@Model.DisplayName" />
    </div>
    <div>
        <label>E-mail:</label><br />
        <input type="email" name="email" value="@Model.Email" />
    </div>
    <button type="submit">Сохранить</button>
</form>

<div style="display: flex; gap: 1.5rem; align-items: flex-start;">

    <!-- ЛЕВАЯ ТАБЛИЦА: группы пользователя -->
    <div style="flex: 1;">
        <h3>Текущие группы</h3>
        <input type="text" id="filter-left" placeholder="фильтр..." oninput="filterTable('left')" style="margin-bottom:.5rem; width:100%;" />
        <table id="left-table" border="1" cellpadding="4" cellspacing="0" style="width:100%; border-collapse:collapse; max-height:300px;">
            <thead>
                <tr>
                    <th>Группа</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var g in userGroups)
            {
                <tr data-name="@g.ToLower()" data-value="@g">
                    <td>@g</td>
                </tr>
            }
            </tbody>
        </table>
    </div>

    <!-- КНОПКИ ПО СЕРЕДИНЕ -->
    <div style="display:flex; flex-direction:column; gap:.5rem; margin-top:2.5rem;">
        <form id="add-form" asp-action="AddGroups" method="post" style="text-align:center;">
            @Html.AntiForgeryToken()
            <input type="hidden" name="id" value="@Model.Sam" />
            <input type="hidden" name="groups" id="add-groups" />
            <button type="submit" style="min-width:60px;">&lt;&lt;</button>
            <!-- &lt;&lt; потому что добавляем С ПРАВОЙ в ЛЕВУЮ -->
        </form>

        <form id="remove-form" asp-action="RemoveGroups" method="post" style="text-align:center;">
            @Html.AntiForgeryToken()
            <input type="hidden" name="id" value="@Model.Sam" />
            <input type="hidden" name="groups" id="remove-groups" />
            <button type="submit" style="min-width:60px;">&gt;&gt;</button>
            <!-- &gt;&gt; потому что убираем из ЛЕВОЙ -->
        </form>
    </div>

    <!-- ПРАВАЯ ТАБЛИЦА: доступные группы -->
    <div style="flex: 1;">
        <h3>Доступные группы</h3>
        <input type="text" id="filter-right" placeholder="фильтр..." oninput="filterTable('right')" style="margin-bottom:.5rem; width:100%;" />
        <table id="right-table" border="1" cellpadding="4" cellspacing="0" style="width:100%; border-collapse:collapse;">
            <thead>
                <tr>
                    <th>Группа</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var g in availableGroups)
            {
                <tr data-name="@g.ToLower()" data-value="@g">
                    <td>@g</td>
                </tr>
            }
            </tbody>
        </table>
    </div>

</div>

<p style="margin-top:1rem;">
    <a asp-action="Index">← Назад к поиску</a>
</p>

@section Scripts {
    <script>
        // чтобы было как в проводнике: ctrl - добавить/убрать, shift - диапазон
        let lastLeftIndex = null;
        let lastRightIndex = null;

        function filterTable(side) {
            const input = document.getElementById(side === 'left' ? 'filter-left' : 'filter-right');
            const table = document.getElementById(side === 'left' ? 'left-table' : 'right-table');
            const val = input.value.toLowerCase();
            for (const tr of table.tBodies[0].rows) {
                const name = tr.getAttribute('data-name');
                tr.style.display = name.includes(val) ? '' : 'none';
            }
        }
        function setupSelectable(tableId, side) {
            const table = document.getElementById(tableId);
            const rows = Array.from(table.tBodies[0].rows);

            rows.forEach((row, index) => {
                row.addEventListener('click', function (e) {
                    let useCtrl = e.ctrlKey || e.metaKey;
                    let useShift = e.shiftKey;
                    let currentIndex = index;

                    // массив строк именно видимых
                    const visibleRows = rows.filter(r => r.style.display !== 'none');
                    const visibleIndex = visibleRows.indexOf(row);

                    if (useShift && (side === 'left' ? lastLeftIndex !== null : lastRightIndex !== null)) {
                        // выделяем диапазон
                        const lastIndex = side === 'left' ? lastLeftIndex : lastRightIndex;
                        const start = Math.min(lastIndex, visibleIndex);
                        const end = Math.max(lastIndex, visibleIndex);
                        visibleRows.forEach((r, i) => {
                            if (i >= start && i <= end) {
                                r.classList.add('selected');
                            }
                        });
                    } else if (useCtrl) {
                        // просто переключаем выделение
                        row.classList.toggle('selected');
                        if (side === 'left') lastLeftIndex = visibleIndex;
                        else lastRightIndex = visibleIndex;
                    } else {
                        // одиночный клик - снимаем со всех и выделяем одну
                        rows.forEach(r => r.classList.remove('selected'));
                        row.classList.add('selected');
                        if (side === 'left') lastLeftIndex = visibleIndex;
                        else lastRightIndex = visibleIndex;
                    }
                });
            });
        }

        // инициализируем обе таблицы
        setupSelectable('left-table', 'left');
        setupSelectable('right-table', 'right');

        // при отправке "добавить" соберём выбранные из ПРАВОЙ таблицы
        document.getElementById('add-form').addEventListener('submit', function (e) {
            const rows = document.querySelectorAll('#right-table tbody tr.selected');
            const values = Array.from(rows).map(r => r.getAttribute('data-value'));
            document.getElementById('add-groups').value = values.join(',');
            // превратим в массив на сервере: ASP.NET сам поймёт groups=aaa,bbb,ccc? — не всегда.
            // поэтому лучше переписать name="groups" несколько раз, но мы сделаем это проще чуть ниже.
            if (values.length === 0) {
                e.preventDefault();
            }
        });

        // при отправке "убрать" соберём выбранные из ЛЕВОЙ таблицы
        document.getElementById('remove-form').addEventListener('submit', function (e) {
            const rows = document.querySelectorAll('#left-table tbody tr.selected');
            const values = Array.from(rows).map(r => r.getAttribute('data-value'));
            document.getElementById('remove-groups').value = values.join(',');
            if (values.length === 0) {
                e.preventDefault();
            }
        });
    </script>

    <style>
        tr.selected {
            background-color: #cde4ff;
        }
        table tbody {
            display: block;
            max-height: 300px;
            overflow-y: auto;
        }
        table thead, table tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
    </style>
}